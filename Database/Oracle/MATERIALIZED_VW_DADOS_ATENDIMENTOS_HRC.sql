CREATE MATERIALIZED VIEW VW_DADOS_ATENDIMENTOS_HRC AS
SELECT A012_CD_CLI, A014_NUM_CONT, A004_CD_ESCR, A052_CD_USUARIO, A001_NUM_ATEND, CODEMPREENDIMENTO, CODCLIENTE, CNPJ, CPR, NOMECLIENTE, A039_NM_FANT, A039_PORTE, NOMECONTATO, DATAHORAINICIOREALIZACAO, DATAHORAFIMREALIZACAO, NOMEREALIZACAO, CODREALIZACAO, CODREALIZACAOCOMP, TIPOREALIZACAO, INSTRUMENTO, ABORDAGEM, DESCREALIZACAO, CODPROJETO, CODACAO, MESANOCOMPETENCIA, CARGAHORARIA, CODSEBRAE, A022_CD_EV, A001_NUMSEQUENCIAL, A022_CD_SIAC, A261_CD_CONT, A784_CD_CATEGORIA, A039_TPO_PJ, NOMEPROJETO, NOMEACAO, CPF, TIPOCLIENTE
FROM(             SELECT T000.A012_CD_cli, 
                T014.A014_num_cont,
                T000.A004_cd_escr,
                T000.A052_cd_usuario,
                T000.A001_num_Atend,
                CASE WHEN T018.A018_TP_CLI = 1 THEN 0 ELSE NVL(T012.A012_PARCEIRO_SIAC,0) END CodEmpreendimento,
                CASE WHEN T018.A018_TP_CLI = 1 THEN NVL(T012.A012_PARCEIRO_SIAC,NVL(T014.A014_PARCEIRO_SIAC,0)) ELSE NVL(T014.A014_PARCEIRO_SIAC,0) END CodCliente,
                NVL(T039.A039_CGC,'') CNPJ,
                NVL(T039.A039_IE,'') CPR,
                T018.A018_NM_CLI NomeCliente,
                NVL(T039.A039_NM_FANT,T018.A018_NM_CLI) A039_NM_FANT,
                NVL(T039.A039_porte,'') A039_porte,
                T261.A261_NM_CONT NomeContato,
                to_char(T001.A001_DT_ATEND,'MM/dd/yyyy hh:mi' ) DataHoraInicioRealizacao,
                to_char(T001.A001_DT_ATEND,'MM/dd/yyyy hh:mi' ) DataHoraFimRealizacao,
                T054.A054_dsc_tp_at NomeRealizacao,
                T001.A001_NUMSEQUENCIAL CodRealizacao,
                0 CodRealizacaoComp,
                'ATN' TipoRealizacao,
                substr(A784_dsc_categoria,1,50) Instrumento,
                substr(A783_dsc_abordagem ,1,1) Abordagem,
                substr ( decode(T001.A001_obs,'','Atendimento SiaWeb',T001.A001_obs),1,200) DescRealizacao,
                T773.cod_projeto_sge CodProjeto,
                T772.CodAcao_Seq CodAcao,
                substr('0'||a001_mes_ref,length(a001_mes_ref),2)||a001_ano_ref MesAnoCompetencia,
                0 CargaHoraria,
                28 CodSebrae,
                0 A022_cd_ev,
                T001.A001_NUMSEQUENCIAL,
                1 A022_cd_siac,
                T014.A261_cd_cont,
                T001_A.A784_CD_CATEGORIA,
                NVL(decode(A039_TPO_PJ,'ECC',1,'PR',2),3) A039_TPO_PJ,
                T773.TITSOL NomeProjeto,
                T772.TITOBJ NomeAcao,
                NVL(T262.A262_NUM_CPF,'') CPF,
                CASE WHEN A018_TP_CLI = 1 THEN 'Físico' ELSE 'Jurídico/Produtor Rural' END TipoCliente
     FROM T000_HISTORICO T000 
     JOIN T001_ATEND T001 ON T001.A001_NUM_ATEND = T000.A001_NUM_ATEND
      AND T001.A004_CD_ESCR      = T000.A004_CD_ESCR
      AND T001.A052_CD_USUARIO   = T000.A052_CD_USUARIO
      AND T001.A012_CD_CLI       = T000.A012_CD_CLI
     JOIN T054_TIPO_ATEND T054 ON T054.A054_CD_TP_AT = T001.A054_CD_TP_AT
     JOIN T012_CLI_ATEND T012 ON T012.A012_CD_CLI = T001.A012_CD_CLI
     JOIN T018_CLI_CADAST T018 ON T018.A012_CD_CLI = T012.A012_CD_CLI
LEFT JOIN T039_PESSOA_JUR T039 ON T039.A012_CD_CLI = T018.A012_CD_CLI
     JOIN T014_CONTATO_CLIENTE T014 ON T014.A012_CD_CLI = T001.A012_CD_CLI AND T014.A012_CD_CLI = T000.A012_CD_CLI
      AND T014.A014_NUM_CONT = T001.A014_NUM_CONT
      AND T014.A261_CD_CONT = T000.A261_CD_CONT
     JOIN T261_CONTATO T261 ON T261.A261_CD_CONT = T014.A261_CD_CONT
     JOIN T262_DAD_AD_CONT T262 ON T262.A261_CD_CONT = T014.A261_CD_CONT
     JOIN T001_atend_sinco T001_A ON T001_A.A004_cd_escr =  T001.A004_cd_escr
      AND T001_A.A052_cd_usuario = T001.A052_cd_usuario
      AND T001_A.A001_num_atend = T001.A001_num_atend
     JOIN T784_CATEGORIA T784 ON T784.A784_cd_categoria = T001_A.A784_cd_categoria
     JOIN T783_ABORDAGEM T783 ON T783.A783_cd_abordagem = T001_A.A783_cd_abordagem     
     JOIN T773_SOLUCAO T773 ON T773.codsol = T001_A.codsol
      AND T773.cod_projeto_sge is not null
      AND T773.zm_ano = T001.a001_ano_ref
     JOIN T772_OBJETIVO T772 ON T772.codobj = T001_A.codobj
      AND T772.ctt_ano = T773.zm_ano                                
      AND NVL(T000.A022_CD_EV,0) = 0
      AND (NVL(T000.A000_HISTORICO,0) NOT IN(22,23,28,29,30,31,36,37,45,46,-22,-23,-28,-29,-30,-31,-36,-37,-45,-46)
      AND NVL(A000_HISTORICO,0) < 1000)
    WHERE T001_A.A785_TIPO IS NOT NULL
      AND a001_dt_atend >= '01-jan-2017')T
GROUP BY A012_CD_CLI, A014_NUM_CONT, A004_CD_ESCR, A052_CD_USUARIO, A001_NUM_ATEND, CODEMPREENDIMENTO, CODCLIENTE, CNPJ, CPR, NOMECLIENTE, A039_NM_FANT, A039_PORTE, NOMECONTATO, DATAHORAINICIOREALIZACAO, DATAHORAFIMREALIZACAO, NOMEREALIZACAO, CODREALIZACAO, CODREALIZACAOCOMP, TIPOREALIZACAO, INSTRUMENTO, ABORDAGEM, DESCREALIZACAO, CODPROJETO, CODACAO, MESANOCOMPETENCIA, CARGAHORARIA, CODSEBRAE, A022_CD_EV, A001_NUMSEQUENCIAL, A022_CD_SIAC, A261_CD_CONT, A784_CD_CATEGORIA, A039_TPO_PJ, NOMEPROJETO, NOMEACAO, CPF, TIPOCLIENTE